# Open Deep Research çŠ¶æ€ç®¡ç†ä¸æµç¨‹æ§åˆ¶æ·±åº¦åˆ†æ

## ğŸ¯ LangGraphçŠ¶æ€å›¾æ ¸å¿ƒæ¦‚å¿µ

Open Deep ResearchåŸºäº**LangGraphæ¡†æ¶**æ„å»ºäº†å¤æ‚çš„å¤šæ™ºèƒ½ä½“å·¥ä½œæµã€‚LangGraphæ˜¯ä¸€ä¸ªä¸“é—¨ä¸ºæ„å»ºæœ‰çŠ¶æ€çš„å¤šæ™ºèƒ½ä½“åº”ç”¨è€Œè®¾è®¡çš„æ¡†æ¶ï¼Œå®ƒå°†å·¥ä½œæµæŠ½è±¡ä¸º**æœ‰å‘å›¾**ï¼Œå…¶ä¸­èŠ‚ç‚¹ä»£è¡¨è®¡ç®—æ­¥éª¤ï¼Œè¾¹ä»£è¡¨çŠ¶æ€è½¬æ¢ã€‚

```mermaid
graph TB
    subgraph "LangGraphçŠ¶æ€ç®¡ç†æ¶æ„"
        A[StateGraph Builder] -->|å®šä¹‰| B[èŠ‚ç‚¹å’Œè¾¹]
        B -->|ç¼–è¯‘| C[å¯æ‰§è¡Œå›¾]
        C -->|è¿è¡Œæ—¶| D[çŠ¶æ€ä¼ é€’]
        
        subgraph "çŠ¶æ€å±‚æ¬¡"
            E[AgentInputState<br/>è¾“å…¥çŠ¶æ€]
            F[AgentState<br/>ä¸»çŠ¶æ€]
            G[SupervisorState<br/>ç›‘ç£è€…çŠ¶æ€]
            H[ResearcherState<br/>ç ”ç©¶è€…çŠ¶æ€]
        end
        
        subgraph "çŠ¶æ€è½¬æ¢"
            I[Commandå¯¹è±¡]
            J[gotoæŒ‡ä»¤]
            K[updateæ“ä½œ]
            L[çŠ¶æ€åˆå¹¶]
        end
        
        D --> E
        D --> F
        D --> G
        D --> H
        
        I --> J
        I --> K
        K --> L
    end
```

## ğŸ”§ çŠ¶æ€å®šä¹‰ä¸ç±»å‹ç³»ç»Ÿ

### 1. åˆ†å±‚çŠ¶æ€æ¶æ„

Open Deep Researché‡‡ç”¨äº†**åˆ†å±‚çŠ¶æ€è®¾è®¡**ï¼Œæ¯ä¸ªå±‚æ¬¡è´Ÿè´£ä¸åŒèŒƒå›´çš„çŠ¶æ€ç®¡ç†ã€‚

#### 1.1 åŸºç¡€çŠ¶æ€å±‚ - MessagesState

```python
from langgraph.graph import MessagesState
from langchain_core.messages import MessageLikeRepresentation

class AgentInputState(MessagesState):
    """æœ€ç®€å•çš„è¾“å…¥çŠ¶æ€ï¼ŒåªåŒ…å«æ¶ˆæ¯åˆ—è¡¨"""
    pass  # ç»§æ‰¿ MessagesState çš„ messages å­—æ®µ

# MessagesState å†…éƒ¨ç»“æ„ (æ¡†æ¶æä¾›)
class MessagesState(TypedDict):
    messages: Annotated[Sequence[MessageLikeRepresentation], add_messages]
```

**è®¾è®¡ç†å¿µ**:
1. **æ¸è¿›å¼å¤æ‚åº¦**: ä»æœ€ç®€å•çš„æ¶ˆæ¯çŠ¶æ€å¼€å§‹
2. **æ¡†æ¶é›†æˆ**: ç›´æ¥åˆ©ç”¨LangGraphçš„å†…ç½®æ¶ˆæ¯ç®¡ç†
3. **ç±»å‹å®‰å…¨**: æ˜ç¡®çš„æ¶ˆæ¯ç±»å‹çº¦æŸ

#### 1.2 å®Œæ•´çŠ¶æ€å±‚ - AgentState

```python
class AgentState(MessagesState):
    """å®Œæ•´çš„ä»£ç†çŠ¶æ€ï¼ŒåŒ…å«æ•´ä¸ªå·¥ä½œæµçš„æ‰€æœ‰çŠ¶æ€ä¿¡æ¯"""
    
    # ç›‘ç£è€…ä¸“ç”¨æ¶ˆæ¯é€šé“
    supervisor_messages: Annotated[list[MessageLikeRepresentation], override_reducer]
    
    # ç ”ç©¶ç®€æŠ¥
    research_brief: Optional[str]
    
    # åŸå§‹ç ”ç©¶ç¬”è®°
    raw_notes: Annotated[list[str], override_reducer] = []
    
    # å¤„ç†åçš„ç ”ç©¶ç¬”è®°
    notes: Annotated[list[str], override_reducer] = []
    
    # æœ€ç»ˆæŠ¥å‘Š
    final_report: str
```

**çŠ¶æ€å­—æ®µè®¾è®¡**:
- **æ¶ˆæ¯éš”ç¦»**: `supervisor_messages` ä¸ä¸»æ¶ˆæ¯æµåˆ†ç¦»
- **æ•°æ®ç®¡é“**: `raw_notes` â†’ `notes` â†’ `final_report` çš„æ•°æ®æµ
- **å¯é€‰å­—æ®µ**: `research_brief` æ”¯æŒè·³è¿‡æ¾„æ¸…é˜¶æ®µ

#### 1.3 ä¸“é—¨åŒ–çŠ¶æ€å±‚

```python
class SupervisorState(TypedDict):
    """ç›‘ç£è€…ä¸“ç”¨çŠ¶æ€ - è½»é‡åŒ–è®¾è®¡"""
    supervisor_messages: Annotated[list[MessageLikeRepresentation], override_reducer]
    research_brief: str
    notes: Annotated[list[str], override_reducer] = []
    research_iterations: int = 0  # ç›‘ç£è€…è¿­ä»£è®¡æ•°å™¨
    raw_notes: Annotated[list[str], override_reducer] = []

class ResearcherState(TypedDict):
    """ç ”ç©¶è€…ä¸“ç”¨çŠ¶æ€ - ä¸“æ³¨å•ä¸€ä»»åŠ¡"""
    researcher_messages: Annotated[list[MessageLikeRepresentation], operator.add]
    tool_call_iterations: int = 0  # å·¥å…·è°ƒç”¨è®¡æ•°å™¨
    research_topic: str             # å½“å‰ç ”ç©¶ä¸»é¢˜
    compressed_research: str        # å‹ç¼©åçš„ç ”ç©¶ç»“æœ
    raw_notes: Annotated[list[str], override_reducer] = []
```

**ä¸“é—¨åŒ–è®¾è®¡ä¼˜åŠ¿**:
1. **çŠ¶æ€éš”ç¦»**: æ¯ä¸ªè§’è‰²åªè®¿é—®å¿…è¦çš„çŠ¶æ€
2. **æ€§èƒ½ä¼˜åŒ–**: å‡å°‘çŠ¶æ€åºåˆ—åŒ–å¼€é”€
3. **ç±»å‹å®‰å…¨**: ç¼–è¯‘æ—¶æ£€æŸ¥çŠ¶æ€å­—æ®µä½¿ç”¨

### 2. é«˜çº§çŠ¶æ€ç®¡ç†æœºåˆ¶

#### 2.1 è‡ªå®šä¹‰çŠ¶æ€å½’çº¦å™¨

```python
def override_reducer(current_value, new_value):
    """æ”¯æŒè¦†ç›–å’Œè¿½åŠ ä¸¤ç§çŠ¶æ€æ›´æ–°æ¨¡å¼"""
    if isinstance(new_value, dict) and new_value.get("type") == "override":
        # è¦†ç›–æ¨¡å¼ï¼šå®Œå…¨æ›¿æ¢å½“å‰å€¼
        return new_value.get("value", new_value)
    else:
        # è¿½åŠ æ¨¡å¼ï¼šåˆå¹¶åˆ°ç°æœ‰å€¼
        return operator.add(current_value, new_value)

# ä½¿ç”¨ç¤ºä¾‹
supervisor_messages: Annotated[list[MessageLikeRepresentation], override_reducer]
```

**å½’çº¦å™¨è®¾è®¡æ¨¡å¼**:
- **çµæ´»æ€§**: æ”¯æŒä¸åŒçš„çŠ¶æ€æ›´æ–°è¯­ä¹‰
- **æ˜¾å¼æ§åˆ¶**: é€šè¿‡ç±»å‹æ ‡è®°æ˜ç¡®æŒ‡å®šæ›´æ–°æ–¹å¼
- **å‘åå…¼å®¹**: é»˜è®¤è¡Œä¸ºä¸ºè¿½åŠ æ¨¡å¼

#### 2.2 çŠ¶æ€æ›´æ–°çš„Commandæ¨¡å¼

```python
from langgraph.types import Command
from typing import Literal

# çŠ¶æ€æ›´æ–°ç¤ºä¾‹
async def clarify_with_user(state: AgentState, config: RunnableConfig) -> Command[Literal["write_research_brief", "__end__"]]:
    # ... ä¸šåŠ¡é€»è¾‘ ...
    
    if response.need_clarification:
        # ç»ˆæ­¢æµç¨‹ï¼Œè¿”å›æ¾„æ¸…é—®é¢˜
        return Command(
            goto=END, 
            update={"messages": [AIMessage(content=response.question)]}
        )
    else:
        # ç»§ç»­æµç¨‹ï¼Œè¿›å…¥ä¸‹ä¸€é˜¶æ®µ
        return Command(
            goto="write_research_brief", 
            update={"messages": [AIMessage(content=response.verification)]}
        )
```

**Commandæ¨¡å¼ä¼˜åŠ¿**:
1. **ç±»å‹å®‰å…¨**: ç¼–è¯‘æ—¶æ£€æŸ¥ç›®æ ‡èŠ‚ç‚¹
2. **çŠ¶æ€ä¸€è‡´æ€§**: åŸå­æ€§çš„çŠ¶æ€æ›´æ–°
3. **æµç¨‹æ§åˆ¶**: æ˜ç¡®çš„ä¸‹ä¸€æ­¥æŒ‡ä»¤

## ğŸ”„ å·¥ä½œæµç¼–æ’ä¸æ§åˆ¶

### 1. çŠ¶æ€å›¾æ„å»ºæ¨¡å¼

#### 1.1 ä¸»å›¾æ„å»º

```python
from langgraph.graph import StateGraph, START, END

# ä¸»å·¥ä½œæµå›¾
deep_researcher_builder = StateGraph(
    AgentState,                    # çŠ¶æ€ç±»å‹
    input=AgentInputState,         # è¾“å…¥ç±»å‹
    config_schema=Configuration    # é…ç½®schema
)

# æ·»åŠ èŠ‚ç‚¹
deep_researcher_builder.add_node("clarify_with_user", clarify_with_user)
deep_researcher_builder.add_node("write_research_brief", write_research_brief)
deep_researcher_builder.add_node("research_supervisor", supervisor_subgraph)  # åµŒå¥—å­å›¾
deep_researcher_builder.add_node("final_report_generation", final_report_generation)

# å®šä¹‰è¾¹ï¼ˆçŠ¶æ€è½¬æ¢ï¼‰
deep_researcher_builder.add_edge(START, "clarify_with_user")
deep_researcher_builder.add_edge("research_supervisor", "final_report_generation")
deep_researcher_builder.add_edge("final_report_generation", END)

# ç¼–è¯‘ä¸ºå¯æ‰§è¡Œå›¾
deep_researcher = deep_researcher_builder.compile()
```

#### 1.2 å­å›¾åµŒå¥—æ¨¡å¼

```python
# ç›‘ç£è€…å­å›¾
supervisor_builder = StateGraph(SupervisorState, config_schema=Configuration)
supervisor_builder.add_node("supervisor", supervisor)
supervisor_builder.add_node("supervisor_tools", supervisor_tools)
supervisor_builder.add_edge(START, "supervisor")
supervisor_subgraph = supervisor_builder.compile()

# ç ”ç©¶è€…å­å›¾
researcher_builder = StateGraph(
    ResearcherState, 
    output=ResearcherOutputState,  # æ˜ç¡®è¾“å‡ºç±»å‹
    config_schema=Configuration
)
researcher_builder.add_node("researcher", researcher)
researcher_builder.add_node("researcher_tools", researcher_tools)
researcher_builder.add_node("compress_research", compress_research)
researcher_builder.add_edge(START, "researcher")
researcher_builder.add_edge("compress_research", END)
researcher_subgraph = researcher_builder.compile()
```

**å­å›¾è®¾è®¡ä¼˜åŠ¿**:
1. **æ¨¡å—åŒ–**: æ¯ä¸ªå­å›¾è´Ÿè´£ç‰¹å®šåŠŸèƒ½
2. **å¯å¤ç”¨**: å­å›¾å¯ä»¥åœ¨å¤šä¸ªåœ°æ–¹ä½¿ç”¨
3. **ç±»å‹éš”ç¦»**: ä¸åŒå­å›¾ä½¿ç”¨ä¸åŒçŠ¶æ€ç±»å‹

### 2. åŠ¨æ€æµç¨‹æ§åˆ¶

#### 2.1 æ¡ä»¶åˆ†æ”¯æ§åˆ¶

```python
async def clarify_with_user(state: AgentState, config: RunnableConfig):
    configurable = Configuration.from_runnable_config(config)
    
    # é…ç½®é©±åŠ¨çš„åˆ†æ”¯
    if not configurable.allow_clarification:
        return Command(goto="write_research_brief")
    
    # LLMé©±åŠ¨çš„åˆ†æ”¯
    response = await model.ainvoke([...])
    
    if response.need_clarification:
        return Command(goto=END, update={...})  # ç»“æŸæµç¨‹ï¼Œç­‰å¾…ç”¨æˆ·è¾“å…¥
    else:
        return Command(goto="write_research_brief", update={...})  # ç»§ç»­æµç¨‹
```

#### 2.2 è¿­ä»£æ§åˆ¶æœºåˆ¶

```python
async def supervisor_tools(state: SupervisorState, config: RunnableConfig):
    configurable = Configuration.from_runnable_config(config)
    research_iterations = state.get("research_iterations", 0)
    
    # å¤šé‡é€€å‡ºæ¡ä»¶
    exceeded_iterations = research_iterations >= configurable.max_researcher_iterations
    no_tool_calls = not most_recent_message.tool_calls
    research_complete = any(tool_call["name"] == "ResearchComplete" 
                           for tool_call in most_recent_message.tool_calls)
    
    if exceeded_iterations or no_tool_calls or research_complete:
        return Command(goto=END, update={...})
    
    # ç»§ç»­ç ”ç©¶å¾ªç¯
    return Command(goto="supervisor", update={...})
```

**è¿­ä»£æ§åˆ¶è¦ç‚¹**:
1. **å¤šé‡é€€å‡º**: æ”¯æŒå¤šç§ç»“æŸæ¡ä»¶
2. **å®‰å…¨é™åˆ¶**: é˜²æ­¢æ— é™å¾ªç¯
3. **æ™ºèƒ½åˆ¤æ–­**: LLMè‡ªä¸»å†³å®šæ˜¯å¦å®Œæˆ

#### 2.3 å¹¶è¡Œæ‰§è¡Œåè°ƒ

```python
async def supervisor_tools(state: SupervisorState, config: RunnableConfig):
    # å¹¶è¡Œä»»åŠ¡è°ƒåº¦
    conduct_research_calls = [tool_call for tool_call in most_recent_message.tool_calls 
                             if tool_call["name"] == "ConductResearch"]
    
    # å¹¶å‘æ§åˆ¶
    conduct_research_calls = conduct_research_calls[:configurable.max_concurrent_research_units]
    
    # å¼‚æ­¥å¹¶è¡Œæ‰§è¡Œ
    coros = [
        researcher_subgraph.ainvoke({
            "researcher_messages": [...],
            "research_topic": tool_call["args"]["research_topic"]
        }, config) 
        for tool_call in conduct_research_calls
    ]
    
    # ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
    tool_results = await asyncio.gather(*coros)
    
    # ç»“æœèšåˆå’ŒçŠ¶æ€æ›´æ–°
    return Command(goto="supervisor", update={
        "supervisor_messages": tool_messages,
        "raw_notes": [raw_notes_concat]
    })
```

## ğŸ® LangGraphé…ç½®ä¸éƒ¨ç½²

### 1. langgraph.jsoné…ç½®åˆ†æ

```json
{
    "dependencies": ["."],
    "graphs": {
        "deep_researcher": "./src/open_deep_research/deep_researcher.py:deep_researcher"
    },
    "env": ".env"
}
```

**é…ç½®è¦ç´ è§£æ**:
- **dependencies**: æŒ‡å®šé¡¹ç›®ä¾èµ–ï¼Œæ”¯æŒæœ¬åœ°åŒ…
- **graphs**: å®šä¹‰å¯ç”¨çš„å›¾åŠå…¶å…¥å£ç‚¹
- **env**: ç¯å¢ƒå˜é‡æ–‡ä»¶ä½ç½®

### 2. è¿è¡Œæ—¶é…ç½®ç®¡ç†

```python
# é…ç½®ä¼ é€’æœºåˆ¶
class Configuration(BaseModel):
    @classmethod
    def from_runnable_config(cls, config: Optional[RunnableConfig] = None) -> "Configuration":
        """ä»è¿è¡Œæ—¶é…ç½®åˆ›å»ºConfigurationå®ä¾‹"""
        configurable = config.get("configurable", {}) if config else {}
        field_names = list(cls.model_fields.keys())
        
        values: dict[str, Any] = {
            field_name: os.environ.get(field_name.upper(), configurable.get(field_name))
            for field_name in field_names
        }
        return cls(**{k: v for k, v in values.items() if v is not None})

# åœ¨èŠ‚ç‚¹å‡½æ•°ä¸­ä½¿ç”¨é…ç½®
async def supervisor(state: SupervisorState, config: RunnableConfig):
    configurable = Configuration.from_runnable_config(config)
    
    # ä½¿ç”¨é…ç½®åˆ›å»ºæ¨¡å‹
    research_model_config = {
        "model": configurable.research_model,
        "max_tokens": configurable.research_model_max_tokens,
        "api_key": get_api_key_for_model(configurable.research_model, config),
    }
```

## ğŸ” çŠ¶æ€æŒä¹…åŒ–ä¸æ¢å¤

### 1. çŠ¶æ€æ£€æŸ¥ç‚¹æœºåˆ¶

```python
from langgraph.checkpoint import MemorySaver, CheckpointTuple

# å†…å­˜æ£€æŸ¥ç‚¹
memory_saver = MemorySaver()

# ç¼–è¯‘æ—¶å¯ç”¨æ£€æŸ¥ç‚¹
deep_researcher = deep_researcher_builder.compile(
    checkpointer=memory_saver,
    interrupt_before=["clarify_with_user"],  # åœ¨ç‰¹å®šèŠ‚ç‚¹å‰ä¸­æ–­
    interrupt_after=["research_supervisor"]   # åœ¨ç‰¹å®šèŠ‚ç‚¹åä¸­æ–­
)

# è¿è¡Œæ—¶é…ç½®
config = RunnableConfig(
    configurable={
        "model": "openai:gpt-4.1",
        "max_concurrent_research_units": 3
    },
    thread_id="research_session_001"  # ä¼šè¯ID
)

# æ¢å¤æ‰§è¡Œ
result = await deep_researcher.ainvoke(
    {"messages": [HumanMessage(content="ç ”ç©¶AIå®‰å…¨æ–¹æ³•")]},
    config=config
)
```

### 2. çŠ¶æ€åºåˆ—åŒ–

```python
# çŠ¶æ€åºåˆ—åŒ–ç¤ºä¾‹
def serialize_state(state: AgentState) -> dict:
    """å°†çŠ¶æ€åºåˆ—åŒ–ä¸ºJSONå‹å¥½æ ¼å¼"""
    return {
        "messages": [msg.dict() for msg in state.get("messages", [])],
        "supervisor_messages": [msg.dict() for msg in state.get("supervisor_messages", [])],
        "research_brief": state.get("research_brief"),
        "notes": state.get("notes", []),
        "final_report": state.get("final_report", "")
    }

def deserialize_state(data: dict) -> AgentState:
    """ä»åºåˆ—åŒ–æ•°æ®æ¢å¤çŠ¶æ€"""
    return AgentState(
        messages=[create_message_from_dict(msg) for msg in data["messages"]],
        supervisor_messages=[create_message_from_dict(msg) for msg in data["supervisor_messages"]],
        research_brief=data["research_brief"],
        notes=data["notes"],
        final_report=data["final_report"]
    )
```

## ğŸ“Š çŠ¶æ€ç®¡ç†æ€§èƒ½ä¼˜åŒ–

### 1. çŠ¶æ€å†…å­˜ç®¡ç†

```python
class OptimizedStateManager:
    """ä¼˜åŒ–çš„çŠ¶æ€ç®¡ç†å™¨"""
    
    def __init__(self, max_message_history: int = 50):
        self.max_message_history = max_message_history
    
    def optimize_state(self, state: AgentState) -> AgentState:
        """ä¼˜åŒ–çŠ¶æ€å¤§å°ï¼Œåˆ é™¤è¿‡æœŸä¿¡æ¯"""
        messages = state.get("messages", [])
        
        # ä¿ç•™æœ€è¿‘çš„æ¶ˆæ¯
        if len(messages) > self.max_message_history:
            # ä¿ç•™ç³»ç»Ÿæ¶ˆæ¯å’Œæœ€è¿‘çš„å¯¹è¯
            system_messages = [msg for msg in messages if isinstance(msg, SystemMessage)]
            recent_messages = messages[-self.max_message_history:]
            messages = system_messages + recent_messages
        
        return {
            **state,
            "messages": messages
        }
    
    def estimate_state_size(self, state: AgentState) -> int:
        """ä¼°ç®—çŠ¶æ€å¤§å°ï¼ˆå­—ç¬¦æ•°ï¼‰"""
        total_size = 0
        for field, value in state.items():
            if isinstance(value, list):
                total_size += sum(len(str(item)) for item in value)
            else:
                total_size += len(str(value)) if value else 0
        return total_size
```

### 2. çŠ¶æ€å‹ç¼©ç­–ç•¥

```python
class StateCompressor:
    """çŠ¶æ€å‹ç¼©å™¨"""
    
    def __init__(self, compression_ratio: float = 0.7):
        self.compression_ratio = compression_ratio
    
    async def compress_messages(self, messages: List[MessageLikeRepresentation]) -> List[MessageLikeRepresentation]:
        """å‹ç¼©æ¶ˆæ¯å†å²"""
        if len(messages) <= 5:
            return messages
        
        # ä¿ç•™å…³é”®æ¶ˆæ¯
        key_messages = [
            msg for msg in messages 
            if isinstance(msg, (SystemMessage, HumanMessage))
        ]
        
        # é€‰æ‹©æ€§ä¿ç•™AIå’Œå·¥å…·æ¶ˆæ¯
        other_messages = [
            msg for msg in messages 
            if not isinstance(msg, (SystemMessage, HumanMessage))
        ]
        
        # æŒ‰é‡è¦æ€§é‡‡æ ·
        target_count = int(len(other_messages) * self.compression_ratio)
        selected_others = self._sample_by_importance(other_messages, target_count)
        
        # åˆå¹¶å¹¶æ’åº
        compressed = key_messages + selected_others
        compressed.sort(key=lambda x: messages.index(x))
        
        return compressed
    
    def _sample_by_importance(self, messages: List, target_count: int) -> List:
        """åŸºäºé‡è¦æ€§é‡‡æ ·æ¶ˆæ¯"""
        if len(messages) <= target_count:
            return messages
        
        # ç®€å•ç­–ç•¥ï¼šä¿ç•™æœ€æ–°çš„æ¶ˆæ¯
        return messages[-target_count:]
```

## ğŸ”§ é«˜çº§æµç¨‹æ§åˆ¶æ¨¡å¼

### 1. æ¡ä»¶è·¯ç”±å™¨

```python
async def conditional_router(state: AgentState, config: RunnableConfig) -> str:
    """æ¡ä»¶è·¯ç”±å™¨ï¼ŒåŸºäºçŠ¶æ€å†³å®šä¸‹ä¸€æ­¥"""
    configurable = Configuration.from_runnable_config(config)
    
    # åŸºäºé…ç½®çš„è·¯ç”±
    if not configurable.allow_clarification:
        return "write_research_brief"
    
    # åŸºäºçŠ¶æ€çš„è·¯ç”±
    messages = state.get("messages", [])
    if not messages:
        return "clarify_with_user"
    
    # åŸºäºæ¶ˆæ¯å†…å®¹çš„è·¯ç”±
    last_message = messages[-1]
    if "clarification" in last_message.content.lower():
        return "clarify_with_user"
    else:
        return "write_research_brief"

# åœ¨å›¾ä¸­ä½¿ç”¨æ¡ä»¶è·¯ç”±
deep_researcher_builder.add_conditional_edges(
    "start_router",
    conditional_router,
    {
        "clarify_with_user": "clarify_with_user",
        "write_research_brief": "write_research_brief"
    }
)
```

### 2. åŠ¨æ€å­å›¾é€‰æ‹©

```python
class DynamicSubgraphSelector:
    """åŠ¨æ€å­å›¾é€‰æ‹©å™¨"""
    
    def __init__(self):
        self.subgraphs = {
            "simple_research": simple_researcher_subgraph,
            "complex_research": complex_researcher_subgraph,
            "multi_agent_research": multi_agent_researcher_subgraph
        }
    
    async def select_subgraph(self, research_brief: str, config: RunnableConfig):
        """åŸºäºç ”ç©¶ç®€æŠ¥é€‰æ‹©åˆé€‚çš„å­å›¾"""
        configurable = Configuration.from_runnable_config(config)
        
        # å¤æ‚åº¦è¯„ä¼°
        complexity_score = await self._assess_complexity(research_brief)
        
        if complexity_score < 0.3:
            return self.subgraphs["simple_research"]
        elif complexity_score < 0.7:
            return self.subgraphs["complex_research"]
        else:
            return self.subgraphs["multi_agent_research"]
    
    async def _assess_complexity(self, research_brief: str) -> float:
        """è¯„ä¼°ç ”ç©¶å¤æ‚åº¦"""
        # ä½¿ç”¨LLMè¯„ä¼°å¤æ‚åº¦
        complexity_prompt = f"è¯„ä¼°ä»¥ä¸‹ç ”ç©¶ä»»åŠ¡çš„å¤æ‚åº¦(0-1)ï¼š{research_brief}"
        # ... LLMè°ƒç”¨é€»è¾‘
        return 0.5  # ç¤ºä¾‹è¿”å›å€¼
```

## ğŸ¯ é¢è¯•è¦ç‚¹æ€»ç»“

### LangGraphæ¡†æ¶æ·±åº¦ç†è§£

1. **çŠ¶æ€å›¾æ¦‚å¿µ**: æœ‰å‘å›¾ã€èŠ‚ç‚¹ã€è¾¹ã€çŠ¶æ€è½¬æ¢
2. **çŠ¶æ€ç®¡ç†**: åˆ†å±‚çŠ¶æ€ã€å½’çº¦å™¨ã€Commandæ¨¡å¼
3. **å·¥ä½œæµç¼–æ’**: å­å›¾åµŒå¥—ã€æ¡ä»¶è·¯ç”±ã€å¹¶è¡Œæ‰§è¡Œ
4. **é…ç½®ç³»ç»Ÿ**: è¿è¡Œæ—¶é…ç½®ã€ç¯å¢ƒå˜é‡ã€ç±»å‹å®‰å…¨

### ç³»ç»Ÿè®¾è®¡èƒ½åŠ›å±•ç¤º

1. **çŠ¶æ€è®¾è®¡**: å¦‚ä½•è®¾è®¡æ¸…æ™°çš„çŠ¶æ€å±‚æ¬¡
2. **æµç¨‹æ§åˆ¶**: å¤æ‚å·¥ä½œæµçš„æ§åˆ¶ç­–ç•¥
3. **æ€§èƒ½ä¼˜åŒ–**: çŠ¶æ€å‹ç¼©ã€å†…å­˜ç®¡ç†
4. **å®¹é”™å¤„ç†**: æ£€æŸ¥ç‚¹ã€æ¢å¤æœºåˆ¶

### æŠ€æœ¯æ·±åº¦è®¨è®º

1. **çŠ¶æ€ä¸€è‡´æ€§**: å¤šæ™ºèƒ½ä½“ç¯å¢ƒä¸‹çš„çŠ¶æ€åŒæ­¥
2. **æ‰©å±•æ€§**: å¦‚ä½•æ‰©å±•æ–°çš„å·¥ä½œæµèŠ‚ç‚¹
3. **ç›‘æ§è°ƒè¯•**: çŠ¶æ€å›¾çš„å¯è§‚æµ‹æ€§
4. **éƒ¨ç½²è¿ç»´**: ç”Ÿäº§ç¯å¢ƒçš„çŠ¶æ€ç®¡ç†

### æ¶æ„æ€ç»´

1. **æŠ½è±¡å±‚æ¬¡**: çŠ¶æ€ã€èŠ‚ç‚¹ã€å›¾çš„æŠ½è±¡å…³ç³»
2. **ç»„åˆæ¨¡å¼**: å­å›¾çš„ç»„åˆå’Œå¤ç”¨
3. **é…ç½®é©±åŠ¨**: é€šè¿‡é…ç½®æ”¹å˜ç³»ç»Ÿè¡Œä¸º
4. **ç±»å‹å®‰å…¨**: ç¼–è¯‘æ—¶çš„ç±»å‹æ£€æŸ¥å’ŒéªŒè¯

---

LangGraphçš„çŠ¶æ€ç®¡ç†ç³»ç»Ÿä½“ç°äº†ç°ä»£å·¥ä½œæµå¼•æ“çš„è®¾è®¡ç²¾é«“ï¼Œé€šè¿‡ç±»å‹å®‰å…¨çš„çŠ¶æ€å®šä¹‰å’Œçµæ´»çš„æµç¨‹æ§åˆ¶ï¼Œå®ç°äº†å¤æ‚å¤šæ™ºèƒ½ä½“ç³»ç»Ÿçš„å¯é è¿è¡Œã€‚ 